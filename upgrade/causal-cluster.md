
## 5.3. Neo4j Causal 클러스터 업그레이드

```
이 섹션에서는 Neo4j Causal 클러스터를 업그레이드하는 방법을 설명합니다.
```

### 5.3.1. 업그레이드를 위한 중요한 사전 정보

모든 업그레이드는 세심한 계획과 테스트를 통해 진행되어야 합니다.

**사전 업그레이드 단계**

1. [섹션 5.1"업그레이드 계획"](/upgrade-planning.md)을 자세히 읽고 여기에 나열된 모든 단계를 수행합니다.

2. 백업을 확인하고 수행합니다:

- neo4j.conf 를 백업합니다. 
- [기본 사용자 및 역할관리](/security/authentication-authorization/native-user-role-management.md)를 사용할 경우 *dbms* 디렉토리를 백업합니다. 
- 안전한 위치에 저장된 전체 백업이 있는지 확인하십시오.
- [섹션 5.1, “업그레이드 계획”](./planning.md)을 참조하여 클러스터 내에 각 서버 별로 새로운 *neo4j.conf* 파일을 준비합니다. 


**한계**

- Neo4j는 다운 그레이드를 지원하지 않습니다. 업그레이드가 안될 경우, 업그레이드 이전 백업 복원을 포함하여 전체 롤백을 수행해야합니다.
- 위험을 최소화하기 위해 업그레이드 중 구성 변경 및 아키텍처 재구성과 같은 작업은 수행하지 않는 것이 좋습니다.

**클러스터 구성 상태 모니터링**

```dbms.cluster.overview()```을 사용하여 업그레이드가 진행되는 동안 클러스터 멤버를 모니터링 합니다. 

**업그레이드 방법**

아래는 Neo4j Casual 클러스터를 업그레이드하는 방법입니다:

- 업그레이드 롤링; 이 메소드는 아래 조건 하에서 사용할 수 있습니다.
	- 고정된 서버에서 업그레이드 롤링
	- 대체가능한 리소스에서 업그레이드 롤링 

- 오프라인 업그레이드; 이 메소드는 항상 사용 가능합니다.


**새로운 Neo4j 버전 설치**

[챕터2, 설치](/installation.md)를 참조하여 소프트웨어 설치하는 방법을 확인합니다. 

**이후 업그레이드**

업그레이드 이전 수행된 백업은 증가하는 온라인 백업 업데이트에서  유효하지 않습니다. 따라서 업그레이드 직후 빈 디렉토리를 사용하여 *전체 백업* 을 수행하는 것이 중요합니다.


### 5.3.2. 업그레이드 롤링

**한계**

롤링 업그레이드는 패치 릴리스간 지원되며 저장소 형식 업그레이드가 필요하지 않은 경우에만 지원됩니다. 특정 업그레이드 경로의 저장 형식 변경 여부를 확인하려면 [릴리스 정보]("https://neo4j.com/release-notes/)를 참조하십시오. 고객 지원부에 문의하여 이 정보를 얻을 수도 있습니다. 롤링 업그레이드를 사용할 수 없는 경우 오프라인 업그레이드 지침을 따르십시오.

**작동하지 않는 시간**

다운 그레이드가 지원되지 않으므로 업그레이드 실패 시 업그레이드 전으로 복구해야 합니다. 가장 안전한 업그레이드 방법은 프로세스 중 쓰기 로드를 비활성화하는 것입니다.


#### 5.3.2.1. 고정 서버에서 업그레이드 롤링 

이 변형은 서버가 고정되어 있으며 내부에서 업데이트할 경우에 적합합니다.

**업그레이드 단계**

  1. 핵심 서버에서:

  a. 인스턴스 종료.
  b. 다음 방법 중 하나를 사용하여 Neo4j를 설치하십시오.

- tarball 또는  zipfile을 설치에 사용하는 경우:

1) Neo4j 3.4.6를 Untar 하거나 unzip 합니다. 
2) 서버의 neo4j.conf 파일을 Configuration 디렉토리에 넣습니다.
3) 예전 설치를 새로운 설치 [*data*](/configuration/file-locations.md) 디렉토리로 복사합니다. ```dbms.directories.data```가 *NEO4J_HOME* 외부 디렉토리를 가리키고있는 경우에는 적용되지 않습니다.

- Debian 또는 RPM을 사용하는 경우:

1) Neo4j 3.4.6를 설치합니다. 
2) 메시지가 나타나면 이전 버전 *neo4j.conf* 파일과 Neo4j 3.4.6의 차이점을 검토하십시오. 업그레이드 이전에 준비한대로 모든 사용자 지정 설정을 3.4.6 설치로 전송합니다.

  c. Neo4j 3.4.6를 시작하고 클러스터 결합을 확인합니다. 

 2. 서버 인스턴스마다 이전 단계를 반복합니다. 

 
#### 5.3.2.2. 교체 가능한 리소스를 위한 롤링 업그레이드

이 변형은 교체 가능한 클라우드 또는 컨테이너 리소스를 사용하는 곳에 적합합니다. 이 방법을 사용하면 이전 인스턴스 제거 전에 새 인스턴스를 추가하기 때문에 가용성 저하를 막을 수 있습니다.

**업그레이드 단계**

1. 이미 있는 인스턴스를 대체하기 위해서 새로운 인스턴스를 Neo4j 3.4.6로 설정
2. 이전 업그레이드 단계에서 준비한 새로운 neo4j.conf를 사용합니다. 
3. 가능하면, 백업 data/dbms 디렉토리를 새 인스턴스의 데이터 디렉토리로 이동합니다. 
4. 새로운 인스턴스를 시작하고, 저장소 사본을 완성시킵니다. 
5. 새 인스턴스가 클러스터 결합하는지 확인합니다. 
6. 이전 인스턴스를 종료합니다. 
7. 서버 인스턴스마다 이전 단계를 반복합니다.

### 5.3.3. 오프라인 업그레이드 

이 변형은 내용이 변경되어 롤링 업그레이드가 불가능하거나 다른 이유로 작동하지 않는 경우에 적합합니다.

**작동되지 않는 시간**

오프라인 업그레이드 메소드가 선택되면 가동 중지 시간을 포함합니다. 생산 방식 장비 업그레이드 테스트는 가동 중지 시간 정보를 제공합니다.

**업그레이드 단계**

1. 클러스터 내에 모든 서버를 종료합니다.
2. 핵심 서버에서:

a. neo4j.conf에서 ```dbms.mode=SINGLE```로 설정합니다.
b. 다음 방법 중 하나를 사용하여 Neo4j를 설치하십시오.

- tarball 또는  zipfile을 설치에 사용하는 경우:

1) Neo4j 3.4.6를 Untar하거나 unzip 합니다. 
2) 이 서버를 위해 준비한 ne4j.conf 파일을 설정 디렉토리에 넣습니다. 
3) ne4j.conf 파일의 ```dbms.allow_upgrade=true```로 설정을 변경하십시오. Neo4j는 이 설정 없이는 작동하지 않습니다.
4) 예전 설치를 새로운 설치 [*data*](/configuration/file-locations.md) 디렉토리로 복사합니다. ```dbms.directories.data```가 *NEO4J_HOME* 외부 디렉토리를 가리키고 있는 경우에는 적용되지 않습니다.

- Debian 또는 RPM을 사용하는 경우:

1) neo4j.conf 파일 내에 ```dbms.allow_upgrade=true```로 설정합니다. 
2) Neo4j 3.4.6를 설치합니다. 
3) 메시지가 나타나면 이전 버전 *neo4j.conf* 파일과 Neo4j 3.4.6의 차이점을 검토하십시오. 업그레이드 이전에 준비한대로 모든 사용자 지정 설정을 3.4.6 설치로 전송합니다. 업그레이드 사전에  준비한대로 모든 사용자 설정을 3.4.6 설치로 전송합니다. 위에서 설정된대로 ```dbms.allow_upgrade = true```를 유지하십시오. Neo4j는 이 설정 없이 시작되지 않습니다.

c. Neo4j 3.4.6를 시작하면 그 동안 업그레이드가 진행됩니다. 
d. 업그레이드 및 진행 표시기 관련 자세한 내용은 debug.log에 기록됩니다.
e. ```dbms.allow_upgrade=false```을 설정하거나 제거합니다.
f. *neo4j.conf*의 ```dbms.mode=CORE```을 읽을 수 있는 Casual 클러스터링으로 설정합니다. 
g. 데이터베이스 사본을 만들기 위해 ```neo4j-admin dump```을 사용합니다.
h. 데이터 베이스는 시작하지 마십시오. 

3. 다른 핵심 서버에서:

a. 데이터베이스 디렉토리를 제거하십시오(기본 설정 :data/databases/graph.db)
b. Neo4j 3.4.6.를 설치하십시오.
c. 이전-업그레이드 단계에서 설정한 모든 사용자 설정을 3.4.6. 설치 파일에 이동합니다.
d. 가능하다면, 백업 디렉토리 *data/dbms*를 새 인스턴스의 *data* 디렉토리로 이동시킵니다.
e. 인스턴스의 ```neo4j-admin unbind```를 실행합니다. 
f. ```neo4j-admin load```를 이용해서, 이 서버에 업그레이드된 데이터베이스를 저장합니다. 

4. 모든 코어 서버를 시작하고, 클러스터 형식을 검토하십시오.
5. 각 읽기 복제본 서버에서:

a. Neo4j를 종료하십시오.
b. 데이터베이스 디렉토리를 삭제하십시오 (기본 구성data/databases/graph.db).
c. Neo4j 3.4.6을 설치하십시오. 
d. 업그레이드 사전 단계에 준비한대로 모든 사용자 지정 설정을 3.4.6 설치로 전송합니다.
e. 가능한 경우, 백업 된 ```data/dbms``` 디렉토리를 새 인스턴스의 데이터 디렉토리에 두십시오.
f. ```neo4j-admin dump/load```를 사용하여 업그레이드된 데이터베이스를 이 서버로 복원하십시오. 또는 이 단계를 생략하고 읽기 복제본이 완전한 저장소 복사본을 만들도록 합니다. 
g. 읽기 복제본을 시작하고 클러스터에 가입하십시오.