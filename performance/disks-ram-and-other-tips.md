
## 9.7. 디스크, RAM과 그 밖의 팁들

```
이 절에서는 Neo4j 실행시, 디스크와 RAM의 성능 고려 사항에 대한 개요를 제공합니다.
```

지속성 솔루션과 마찬가지로 성능은 사용 중인 지속성 미디어에 따라 크게 달라집니다. 일반적으로, 저장소가 빠르고 더 많은 데이터를 RAM에 넣을 수록 성능이 향상 됩니다. 

### 9.7.1. 저장소 

여러 개의 디스크나 지속성 미디어를 사용하는 경우, 파일과 트랜잭션 로그를 나누어 디스크에 저장하는 것이 좋습니다. 탐색 시간이 짧은(low seek time) 디스크에 파일을 보관하면 읽기 작업시 이상이 생길 수 있습니다. 현재, 일반적인 기계식 드라이브의 평균 탐색 시간은 약 5ms입니다. 페이지 캐시에 할당된 RAM의 크기가 너무 작으면, 쿼리나 트래버스(traversal)가 매우 느려질 수 있습니다. 최신의 좋은 SATA 지원 SSD의 평균 탐색 시간이 100ms 미만이므로, 적어도 일반 5ms보다는 50배 이상 빠르게 실행됩니다. 그러나 여전히 RAM에 액세스하는 것보다 수십배, 또는 수백배 느립니다.

디스크 적중 방지를 위해 더 많은 RAM이 필요합니다. 표준 기계식 드라이브에서 2-3GB의 RAM을 사용하여 수천만 개의 프리미티브(노드, 관계, 속성) 그래프를 처리 할 수 있습니다. 8-16 GB의 RAM을 가진 서버는 수억 개의 프리미티브 그래프를 처리 할 수 있으며, 16-64 GB의 서버는 수십억 개의 프리미티브를 처리 할 수 있습니다. 그러나 더 성능 좋은 SSD에 투자하면, 더 적은 RAM에서 더 큰 그래프를 처리 할 수 있습니다.

프로그램이 실행 중일 때, 정보를 수집하려면 ```dstat``` 또는 ```vmstat```와 명령어를 사용합니다. 스왑이나 페이징 수가 높으면 루씬(Lucene)인덱스가 메모리 설정과 맞지 않는 신호입니다. 이 경우 인덱스 룩업을 수행하는 쿼리의 대기 시간(lateny)이 길어집니다.

### 9.7.2. 페이지 케시 

Neo4j를 실행하면 페이지 캐시가 비어있고 워밍업이 필요합니다. 페이지 및 그래프 데이터 내용은 필요할 때 쿼리에서 메모리에 로드됩니다. 특히, 저장소 용량이 클 경우 워밍업 시간이 더 오래 걸릴 수 있습니다. 많은 블록이 드라이브에서 읽히고 높은 IO 대기 시간이 오래 걸리는 것은 흔한 일 입니다. 이것은 페이지 캐시의 초기 스파이크로 페이지 캐시 메트릭에 표시됩니다. 그후 페이지 폴트 활동이 점차 감소하여 페이지 폴트 스파이크가 발생하며 메모리에 없는 페이지를 요청하는 쿼리의 확률이 감소합니다. 
 
#### 9.7.2.1. 페이지 캐시 웜업 

Neo4j 앤터프라이즈 버전은 활성 페이지 캐시 워밍업 기능이 있어 페이지 폴트 스파이크를 줄이고 페이지 캐시 워밍업을 빠르게합니다. 이것은 데이터 베이스가 실행되는 동안 저장소 파일의 캐시 프로필을 주기적으로 기록하여 수행됩니다. 이 프로파일은 메모리에있는 데이터와없는 데이터에 대한 정보가 들어 있으며 저장소 디렉토리의 하위 디렉토리 "profiles"에 저장됩니다. Neo4j가 나중에 재시작 되면 캐시 프로파일을 찾아 프로파일이 생성시 메모리에 있던 것과 같은 데이터를 로드 합니다. 또한 프로파일은 온라인 백업 및 클러스터 저장소-복사 일부로 제본되며, 클러스터를 결합하는 새로운 데이터베이스 인스턴스를 준비합니다. 

#### 9.7.2.2. IOPS 한계 체크포인트 

Neo4j는 체크 포인트 프로세스 일부인 페이지 캐시를 백그라운드에서 플러시(flush)합니다. 이것은 높은 쓰기 IO 활동 기간으로 표시됩니다. 데이터베이스 쓰기가 많은 작업 부하를 유발한다면, 체크포인트는 쿼리를 처리하는 IO 대역폭을 줄여 데이터베이스 속도를 저하시킵니다. 많은 I/O를 처리하는 빠른 SSD에서 데이터베이스를 실행하면 문제는 크게 줄어 듭니다. 사용자 환경에서 SSD를 이용할 수 없거나 충분하지 않을 때 인위적인 IOPS 한계 정보를 체크포인트 과정에 넣을 수 있습니다. ```dbms.checkpoint.iops.limit```는 체크포인트 프로세스가 사용할 수 있는 IO 대역폭을 제한합니다. 체크포인트를 진행하는 경우 각 IO는 8KB를 사용합니다. 예를 들어, 한계치가 300인 IOPS는 초당 오직 2.5 Mib 속도로 쓰기를 허용하지만, 체크포인트가 완성되는데 오래걸립니다. 체크포인트 사이 긴 시간은 더 많은 트랜잭션 로그 데이터가 조정되도록하고, 회복 시간을 늘릴 수도 있습니다. 체크포인트 및 로그 잘라내기 간 관계와 관련된 내용은 [트랜잭션 로그](/configuration/transaction-logs.md) 섹션을 참조하면 됩니다. IOPS 한계는 IO 사용과 체크포인트 시간 간 균형을 맞추기 위해서 [런타임](/configuration/dynamic-settings.md)에서 변경할 수 있습니다. 


