
### 7.1.4.4. 기본 사용자 및 역할 관리 절차 

```
이 절에서는 Neo4j의 기본 사용자 및 역할 관리 절차에 대해서 설명합니다. 
```

 
이 기능의 부분 집합은 커뮤니티  버전에서도 사용 가능합니다. 아래 표에는 유효한 기능을 표시합니다. 더 자세한 정보는 [섹션 A.3, 커뮤니티 버전의 사용자 관리](https://neo4j.com/docs/operations-manual/3.4/reference/user-management-community-edition/)를 참조하십시오. 

Neo4j에서 네이티브 사용자 및 역할은 Cypher의 내장 프로시저로 관리됩니다. 이 절에서는 간단한 예제와 사용자 관리를 위한 모든 보안 절차 목록을 제공합니다. 아래 예제를 실행하려면 Neo4j 브라우저 또는 Neo4j 사이퍼 쉘을 사용해야 합니다. 

아래 표는 사용가능한 절차 목록입니다:

| 절차명                               | 설명                                                   | 사용가능한 역할                           | 커뮤니티 버전에서 이용 여부 |
| ------------------------------------ | ------------------------------------------------------ | ----------------------------------------- | --------------------------- |
| `dbms.security.activateUser`         | 정지된 사용자를 활성화합니다.                          | [admin]                                   |                             |
| `dbms.security.addRoleToUser`        | 사용자에게 역할을 할당합니다.                          | [admin]                                   |                             |
| `dbms.security.changePassword`       | 현재 사용자 비밀번호를 변경합니다.                     | [reader,editor,publisher,architect,admin] | ✔                           |
| `dbms.security.changeUserPassword`   | 주어진 사용자 비밀번호를 변경합니다.                   | [admin]                                   |                             |
| `dbms.security.createRole`           | 새로운 역할을 생성합니다.                              | [admin]                                   |                             |
| `dbms.security.createUser`           | 새로운 생성자를 생성합니다.                            | [admin]                                   | ✔                           |
| `dbms.security.deleteRole`           | 특정 역할을 제거합니다. 할당된 모든 역할은 제거됩니다. | [admin]                                   |                             |
| `dbms.security.deleteUser`           | 특정 사용자를 제거합니다.                              | [admin]                                   | ✔                           |
| `dbms.security.listRoles`            | 가능한 역할을 모두 나열합니다.                         | [admin]                                   |                             |
| `dbms.security.listRolesForUser`     | 특정 사용자에게 할당된 모든 역할을 나열합니다.         | [admin]                                   |                             |
| `dbms.security.listUsers`            | 모든 로컬 사용자를 나열합니다.                         | [admin]                                   | ✔                           |
| ```dbms.security.listUsersForRole``` | 특정 역할이 부여된 현재 사용자를 나열합니다.           | [admin]                                   |                             |
| `dbms.security.removeRoleFromUser`   | 사용자에게 할당된 역할을 해제합니다.                   | [admin]                                   |                             |
| `dbms.security.suspendUser`          | 지정된 사용자 를 중지시킵니다.                         | [admin]                                   |                             |
| `dbms.showCurrentUser`               | 현재 사용자를 보여줍니다.                              | [reader,editor,publisher,architect,admin] | ✔                           |
| `dbms.procedures`                    | 절차별 역할을 나열합니다.                              | [reader,editor,publisher,architect,admin] | 해당되지 않음               |

#### 일시 중지 된 사용자 활성화

사용자가 다시 원래 용량의 데이터에 액세스 하도록 관리자는 중지된 사용자를 활성화할 수 있습니다. 
  
**구문:**

```
CALL dbms.security.activateUser(username, requirePasswordChange)
```

| 이름                    | 종류    | 설명                                                         |
| ----------------------- | ------- | ------------------------------------------------------------ |
| `username`              | String  | 이것은 활성화 될 사용자의 이름입니다.                        |
| `requirePasswordChange` | Boolean | 이것은 기본값이 ```true```이며 선택가능합니다. 이것이 사실이라면 (i) 사용자는 다음 로그인 할 때 암호를 변경해야하며 (ii) 암호가 변경 될 때까지 다른 작업을 수행 할 수 없습니다. |

**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 사용자 이름은 시스템에 존재하지 않습니다.
- 사용자 이름은 현재 사용자와 일치합니다.(현재 사용자 활성화는 허용하지 않습니다.)

**고려사항:**

이것은 멱등(idempotent) 절차입니다. 

**예 7.1. 일시정지된 사용자 활성화**

아래 예는 사용자이름 ```jackgreen```으로 활성화 됩니다. ```jackgreen```이 다음에 로그인할 때 암호를 변경해야 합니다. 

```
CALL dbms.security.activateUser('jackgreen')
```

**변수:**

| 이름       | 종류   | 설명                                      |
| ---------- | ------ | ----------------------------------------- |
| `roleName` | String | 이것은 사용자에게 할당된 역할 명 입니다.  |
| `username` | String | 이것은 역할에 할당된 사용자의 이름입니다. |


**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 시스템 내 사용자 이름은 존재하지 않습니다.
- 사용자 이름에 영숫자와 `_`문자 이외 다른 문자가 포함되어 있습니다. 
- 시스템 내 역할 명은 존재하지 않습니다. 
- 역할 이름에는 영숫자와 `_`문자 이외 문자가 포함됩니다. 

**고려사항:**

이것은 멱등(idempotent) 절차입니다. 

**예 7.2. 사용자에게 역할 할당**

다음 예제는 역할 ```publisher```을 사용자 이름이 'johnsmith'인 사용자에게 할당합니다.

```
CALL dbms.security.addRoleToUser('publisher', 'johnsmith')
```

#### 현재 사용자 비밀번호 변경

활성화된 사용자는 그들 자신의 비밀번호를 언제든지 변경할 수 있습니다. 

**구문:**

```
CALL dbms.security.changePassword(password, requirePasswordChange)
```

**변수:**

| 이름                    | 종류    | 설명                                                         |
| ----------------------- | ------- | ------------------------------------------------------------ |
| `password`              | String  | 이것은 현재 사용자의 새로운 비밀번호 입니다.                 |
| `requirePasswordChange` | Boolean | 선택 사항이며 기본값은 ```false```입니다. 이것이 사실이라면 (i) 현재 사용자는 다음에 로그인 할 때 자신의 암호를 변경해야하며 (ii) 현재 사용자가 암호를 변경하기 전까지는 다른 작업을 수행 할 수 없습니다. |

**예외:**

- 암호는 빈 문자열입니다.
- 암호는 현재 사용자의 이전 비밀번호와 동일합니다. 

**예 7.3. 현재 사용자 비밀번호 변경**

아래 예는 현재 사용자 비밀번호를 'h6u4%kr'로 변경합니다. 

```
CALL dbms.security.changePassword('h6u4%kr')
```

#### 사용자의 주어진 암호 변경

관리자는 시스템 내 모든 사용자의 암호를 변경할 수 있습니다. 그 대신에, 현재 사용자는 그들 자신의 비밀번호를 변경할 수 있습니다. 

**구문:**

```
CALL dbms.security.changeUserPassword(username, newPassword, requirePasswordChange)
```

| 이름                    | 종류    | 설명                                                         |
| ----------------------- | ------- | ------------------------------------------------------------ |
| `username`              | String  | 이것은 비밀번호가 변경될 사용자의 이름입니다.                |
| `newPassword`           | String  | 이것은 사용자의 새로운 암호입니다.                           |
| `requirePasswordChange` | Boolean | 선택 사항이며 기본값은 ```true```입니다. 이것이 사실이라면 (i) 사용자는 다음에 로그인 할 때 암호를 변경해야하며 (ii) 암호가 변경 될 때까지 다른 작업을 수행 할 수 없게됩니다. |

**예외:**

- 관리자는 현재 사용자가 아니며 사용자 이름은 현재 사용자 이름과 일치하지 않습니다.
- 시스템 내 사용자 이름은 존재하지 않습니다.
- 암호는 빈 문자열입니다.
- 암호는 현재 사용자의 이전 비밀번호와 동일합니다. 

**고려 사항:**

- 이 절차는 현재 사용자가 관리자 여부에 관계없이 자신의 암호를 변경하도록 호출할 수 있습니다.
- 이 절차는 관리자가 다른 사용자 암호를 변경하도록 호출할 수 있습니다.
- 사용자의 암호를 변경하는 것 외에 모든 사용자의 세션을 즉시 종료하고 실행중인 트랜잭션을 롤백합니다.

**예 7.4. 주어진 사용자 암호 변경**

아래 예는 사용자 명 'joebloggs'의 암호를 'h6u4%kr'로 변경합니다. 'joebloggs'가 다음에 로그인할 때, 암호를 변경해야 합니다. 

```
CALL dbms.security.changeUserPassword('joebloggs', 'h6u4%kr')
```

#### 새로운 역할 생성

관리자는 시스템 내 사용자 역할을 생성할 수 있습니다. 

**구문:**

```
CALL dbms.security.createRole(roleName)
```

**변수:**

| 이름       | 종류   | 설명                         |
| ---------- | ------ | ---------------------------- |
| `roleName` | String | 이것은 생성될 역할 명입니다. |


**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 역할 명은 이미 시스템에 존재합니다. 
- 역할 명은 비어있습니다. 
- 역할 명에 영숫자와 `_`문자 이외 다른 문자가 포함되어 있습니다. 
- 역할 명은 네이티브 역할 중 하나와 동일합니다: ```reader```, ```publisher```, ```architect```, 와 ```admin```.

**예 7.5. 새로운 역할 생성**

아래 새로운 사용자 역할을 생성하는 예 입니다.

```
CALL dbms.security.createRole('operator')
```

#### 새로운 사용자 생성

관리자는 새로운 사용자를 만들 수 있습니다. 이 작업은 사용자에게 역할을 지정하여 수행해야 합니다. 

**구문:**

```
CALL dbms.security.createUser(username, password, requirePasswordChange)
```

| 이름                    | 종류    | 설명                                                         |
| ----------------------- | ------- | ------------------------------------------------------------ |
| `username`              | String  | 이것은 사용자 이름입니다.                                    |
| `password`              | String  | 이것은 사용자의 암호입니다.                                  |
| `requirePasswordChange` | Boolean | 선택 사항이며 기본값은 ```true```입니다. 이것이 사실이라면 (i) 사용자가 처음 로그인 할 때 암호를 변경해야하며 (ii) 암호가 변경 될 때까지 다른 작업을 수행 할 수 없게됩니다. |

**예외**

- 현재 사용자는 관리자가 아닙니다.
- 사용자 이름에는 ASCII 문자 이외의 문자가 포함되어 있습니다. ```!```및 ```~``` 또는 ```:``` 및 ```,```을 포함합니다.
- 사용자 명은 이미 시스템에서 사용중입니다. 
- 암호는 빈 문자열 입니다. 

**예 7.6. 새로운 사용자 생성**

아래 예는 사용자 `johnsmith`와 암호 `h6u4%kr`를 생성합니다. 사용자 'johnsmith'가 처음 로그인하면, 비밀번호를 변경해야 합니다. 

```
CALL dbms.security.createUser('johnsmith', 'h6u4%kr')
```

#### 지정된 역할 삭제
 
관리자는 시스템에서 사용자 역할을 제거할 수 있습니다. 네이티브 역할 ```reader```, ```publisher```, ```architect```, 및 ```admin``` ([섹션 7.1.4.1, 네이티브 역할](./native-roles.md))은 제거할 수 없습니다. 
 
**구문:**

```
CALL dbms.security.deleteRole(roleName)
```

| 이름       | 종류   | 설명                          |
| ---------- | ------ | ----------------------------- |
| `roleName` | String | 이것은 제거될 역할 명 입니다. |


**예외:**

- 현재 유저는 관리자가 아닙니다.
- 역할 명은 시스템 내에 존재하지 않습니다.
- 역할 명은 네이티브 역할과 일치합니다: ```reader```, ```publisher```, ```architect```, 및 ```admin```.

**고려사항:**

모든 역할 할당은 제거됩니다.

**예 7.7 지정된 역할 제거**

아래 예는 사용자 역할 `operator`을 시스템에서 제거합니다. 

```
CALL dbms.security.deleteRole('operator')
```

#### 지정된 사용자 삭제

관리자는 시스템에서 사용자를 영구적으로 제거할 수 있습니다. 이 작업을 실행 취소할 수 없으므로 의심스러운 경우 사용자를 중지하는 것이 좋습니다.

**구문:**

```
CALL dbms.security.deleteUser(username)
```

| 이름       | 종류   | 설명                            |
| ---------- | ------ | ------------------------------- |
| `username` | String | 이것은 제거될 사용자 명 입니다. |


**예외:**

- 현재 유저는 관리자가 아닙니다.
- 사용자 명은 시스템 내에 존재하지 않습니다.
- 사용자 명은 현재 사용자와 일치합니다(현재 사용자 제거는 허용하지 않습니다.) 


**고려사항:**

- 사용자를 제거하기 전에 사용자에게 할당된 역할을 제거할 필요는 없습니다. 
- 사용자를 삭제하면 모든 사용자의 세션이 즉시 적용되고 실행 중인 모든 트랜잭션이 롤백됩니다.
- 현재 사용자가 자신을 삭제할 수 없기 때문에 시스템에는 항상 적어도 한 명의 관리자가 있습니다.

**예 7.8. 지정된 사용자 삭제**

아래 예는 사용자 `janebrown`을 제거합니다. 

```
CALL dbms.security.deleteUser('janebrown')
```

#### 모든 이용가능한 역할 나열 

관리자는 시스템 내에 할당된 모든 사용자를 확인할 수 있습니다. 

**구문:**
```
CALL dbms.security.listRoles()

```

**반환 값:**

| 이름    | 종류         | 설명                                                     |
| ------- | ------------ | -------------------------------------------------------- |
| `role`  | String       | 이것은 역할 명 입니다.                                   |
| `users` | List<String> | 이것은 모든 역할을 할당한 모든 사용자 이름을 나열합니다. |


**예외:**

현재 사용자는 관리자가 아닙니다. 

**예 7.9. 이용가능한 모든 역할 나열**

아래 예는 시스템 내 역할에 할당된 모든 사용자 역할과 이름을 보여줍니다.

```
CALL dbms.security.listRoles()
```

```
+------------------------------+
| role        | users          |
+------------------------------+
| "reader"    | ["bill"]       |
| "architect" | []             |
| "admin"     | ["neo4j"]      |
| "publisher" | ["john","bob"] |
+------------------------------+
4 rows
```

#### 특정 사용자에게 할당된 모든 역할 나열 

활성화된 모든 사용자는 그들에게 할당된 모든 역할을 확인할 수 있습니다. 관리자는 시스탬 내 모든 사용자에게 할당된 역할을 확인할 수 있습니다. 

**구문:**

```
CALL dbms.security.listRolesForUser(username)
```

**변수:**

| 이름       | 종류   | 설명                     |
| ---------- | ------ | ------------------------ |
| `username` | String | 이것은 사용자 명 입니다. |

**반환 값:**

| 이름    | 종류   | 설명                                              |
| ------- | ------ | ------------------------------------------------- |
| `value` | String | 요청한 사용자에게 할당 된 모든 역할이 반환됩니다. |

**예외:**

- 현재 사용자는 관리자가 아니며, 사용자 명은 현재 사용자와 일치하지 않습니다.
- 사용자 명은 시스템에 존재하지 않습니다. 

**고려사항:**

-현재 사용자의 관리자 여부에 관계없이 사용자가 자신의 역할을보기 위해 절차를 호출할 수 있습니다.
- 이 절차는 관리자가 다른 사용자의 역할을보기 위해 호출할 수 있습니다.

**예 7.10. 지정된 사용자에게 할당된 모든 역할 나열**

아래 예는 역할 ```reader``` 및 ```publisher```을 가진 사용자 `johnsmith`의 모든 역할을 나열합니다. 

```
CALL dbms.security.listRolesForUser('johnsmith')
```

```
+-------------+
| value       |
+-------------+
| "reader"    |
| "publisher" |
+-------------+
2 rows
```

#### 모든 로컬 사용자 나열 

관리자는 시스템 내 모든 사용자 역할을 확인할 수 있습니다. 

구문:
```
CALL dbms.security.listUsers()
```

반환 값:

| 이름       | 종류         | 설명                                                         |
| ---------- | ------------ | ------------------------------------------------------------ |
| `username` | String       | 이것은 사용자 명 입니다.                                     |
| `roles`    | List<String> | 이것은 사용자에게 할당된 역할을 나열합니다.                  |
| `flags`    | List<String> | 이것은 사용자가 중지되었거나 암호 변경 여부를 나타내는 일련의 플래그입니다. |

**예외:**

현재 사용자는 관리자가 아닙니다. 

**예 7.11. 모든 로컬 사용자 나열**

다음 예에서는 시스템의 각 사용자에 대해 사용자 이름, 할당 된 역할과 사용자 일시 중지 및 암호 변경 여부를 보여줍니다.

```
CALL dbms.security.listUsers()
```

```
+---------------------------------------------------------------------+
| username | roles                     | flags                        |
+---------------------------------------------------------------------+
| "neo4j"  | ["admin"]                 | []                           |
| "anne"   | []                        | ["password_change_required"] |
| "bill"   | ["reader"]                | ["is_suspended"]             |
| "john"   | ["architect","publisher"] | []                           |
+---------------------------------------------------------------------+
4 rows
```

#### 현재 지정된 사용자에게 할당된 모든 역할 나열

관리자는 사용자에게 할당된 모든 역할을 확인할 수 있습니다. 

**구문:**

```
CALL dbms.security.listUsersForRole(roleName)
```

| 이름       | 종류   | 설명                   |
| ---------- | ------ | ---------------------- |
| `roleName` | String | 이것은 역할 명 입니다. |


**반환 값:**

| 이름    | 종류   | 설명                                           |
| ------- | ------ | ---------------------------------------------- |
| `value` | String | 요청된 역할에 할당된 모든 사용자를 리턴합니다. |


**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 역할 명은 시스템 내에 존재하지 않습니다. 

**예 7.12. 현재 지정된 역할에 할당된 모든 사용자 나열**

다음 예제에서는 역할 ```publisher```에 할당된 모든 사용자 ( 'bill'및 'anne')를 나열합니다.

```
CALL dbms.security.listUsersForRole('publisher')
```

```
+--------+
| value  |
+--------+
| "bill" |
| "anne" |
+--------+
2 rows
```

#### 사용자에 할당된 역할 해제

관리자는 시스템 내 모든 사용자 역할을 제거하여, 사용자가 모든 역할에서 규정한 데이터 관련 작업을 수행할 수 없도록 합니다. 

**구문:**

```
CALL dbms.security.removeRoleFromUser(roleName, username)
```

| 이름       | 종류   | 설명                                       |
| ---------- | ------ | ------------------------------------------ |
| `roleName` | String | 이것은 사용자에서 제거되는 역할 명 입니다. |
| `username` | String | 이것은 역할을 제거할 사용자의 이름입니다.  |


**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 사용자 명은 시스템에 존재하지 않습니다. 
- 역할 명은 시스템에 존재하지 않습니다. 
- 사용자 명은 현재 사용자의 이름이며, 그 역할은 ```admin```입니다. 

**고려사항:**

- 만약 사용자 명이 현재 사용자이고 그 역할이 ```admin```이라면 오류가 발생합니다. 현재 사용자는 관리자 권한에서 제외될 수 없습니다.
- 현재 사용자가 관리 역할을 자체 제거할 수 없으므로, 시스템에는 항상 최소 한 명의 관리자가 있습니다.
- 이것은 멱등 프로시저입니다.


**예 7.13. 사용자의 역할 할당 해제**

아래 예에서는 사용자 명 `johnsmith`에서 역할 ```publisher```을 제거합니다. 

```
CALL dbms.security.removeRoleFromUser('publisher', 'johnsmith')
```

#### 지정된 사용자 일시 중지

관리자는 시스템에서 사용자를 중지시킬 수 있습니다. 중지된 사용자는 이후 단계에서 활성화 됩니다. 

**구문:**
```
CALL dbms.security.suspendUser(username)
```

| 이름       | 종류   | 설명                               |
| ---------- | ------ | ---------------------------------- |
| `username` | String | 이것은 중지될 사용자의 이름입니다. |

**예외:**

- 현재 사용자는 관리자가 아닙니다.
- 사용자는 시스템에 존재하지 않습니다.
- 사용자 이름은 현재 사용자 이름과 일치합니다 (즉, 현재 사용자 일시 중지는 허용되지 않습니다).

**고려사항:**

- 사용자를 중지하면 모든 사용자 세션에 바로 영향을 미치고 종료되며 실행 중인 모든 트랜잭션은 롤백됩니다.
- 일시 중지된 사용자의 모든 속성 (할당된 역할 및 암호)은 그대로 유지됩니다.
- 일시 중지된 사용자는 시스템에 로그인할 수 없습니다. 
- 현재 사용자 자신은 일시 중지할 수 없기 때문에, 시스템에는 항상 활성화된 관리자가 적어도 1 명이상 존재해야 합니다. 
- 이것은 멱등 프로시저입니다.


**예 7.14. 지정된 사용자 일시 정지**

아래 예는 사용자 `billjones`을 중지시킵니다. 

```
CALL dbms.security.suspendUser('billjones')
```

#### 현재 사용자 명시 

일시 중지된 사용자의 모든 속성 (할당 된 역할 및 암호)은 그대로 유지됩니다.

**구문:**

```
CALL dbms.showCurrentUser()
```

**반환 값:**

| 이름       | 종류         | 설명                                                         |
| ---------- | ------------ | ------------------------------------------------------------ |
| `username` | String       | 이것은 사용자 명 입니다.                                     |
| `flags`    | List<String> | 이것은 사용자가 암호를 변경해야하는지 여부를 나타내는 플래그입니다. |


**예 7.15. 현재 사용자 명시**

아래 예는 그 암호를 변경하지 않아도 되는 현재 사용자 `johnsmith`를 보여줍니다.

```
CALL dbms.showCurrentUser()
```

```
+-------------------------------------------------+
| username    | roles                     | flags |
+-------------------------------------------------+
| "johnsmith" | ["architect","publisher"] | []    |
+-------------------------------------------------+
1 row
```

#### 절차 별 역할 나열 

활성화된 모든 사용자는 실행 권한을 포함하여 시스템의 모든 절차를 볼 수 있습니다.

**구문:**

```
CALL dbms.procedures()
```

**반환 값:**

| 이름          | 유형         | 설명                                                 |
| ------------- | ------------ | ---------------------------------------------------- |
| `name`        | String       | 이것은 절차 명 입니다.                               |
| `signature`   | String       | 이것은 절차의 서명입니다.                            |
| `description` | String       | 이것은 절차의 요약 내용입니다.                       |
| `roles`       | List<String> | 이것은 절차 실행 권한을 가진 모든 역할 리스트입니다. |


**예 7.16. 절차 별 역할 나열**

다음 예제는 네 가지 보안 프로 시저에 대해 프로시저 이름, 설명 및 실행 권한이 있는 역할을 보여줍니다.
 
```
CALL dbms.procedures()
YIELD name, signature, description, roles
WITH name, description, roles
WHERE name contains 'security'
RETURN name, description, roles
ORDER BY name
LIMIT 4
```

```
+--------------------------------------------------------------------------------------------------------------+
|name                              |description                          |roles                                |
+--------------------------------------------------------------------------------------------------------------+
|"dbms.security.activateUser"      |"Activate a suspended user."         | ["admin"]                           |
|"dbms.security.addRoleToUser"     |"Assign a role to the user."         | ["admin"]                           |
|"dbms.security.changePassword"    |"Change the current user's password."| ["reader","editor","publisher", ... |
|"dbms.security.changeUserPassword"|"Change the given user's password."  | ["admin"]                           |
+--------------------------------------------------------------------------------------------------------------+
4 rows
```